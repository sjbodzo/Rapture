<html>
  <head>
    <title>Visualizing A PDB File
    </title>
  </head>
  <body>
    <input type="file" id="pdb_input" onchange='handleFiles(this)'>
    <span id="spanBox">AAA</span>
    <script>

      //storing coords and seq in map obj's
      var x_map, y_map, z_map, seq_map;
      x_map = []; y_map = []; z_map = []; seq_map = [];

      //parsing file string to my maps
      function parseHandler(src) {
        //only grab the atom information to know atom coordinates
        //var splitSrc = src.split(splitPattern);
        //NOTE: aa chains grown in amino to carboxyl dir, define each
        //      new aa as occuring on the line that references the CA atom
        //NOTE: pdb limits atoms to length in range [0,99999]
        var atomRowPattern = /(\w+)\s*\w{3}\s(\w)\s+\d+\s+((?:([0-9\.-]+)\s+){3}).*(\w)/;
        //NOTE: [1][1] -> atom description letter;
        //      [1][2] -> amino acid letter
        //      [1][3] -> x,y,z;
        //      [1][4] -> atom letter
        var atomInfoArray = [];
        for (var i = 1, k = 0; i < src.length; i++) {
          atomInfoArray[i] = atomRowPattern.exec(src[i]);
          if(atomInfoArray[i][1] == "CA") {
            console.log("current letter -> %s", atomInfoArray[i][1]);
            seq_map[k] = atomInfoArray[i][2];
            ++k;
            //console.log("current letter -> %s", atomInfoArray[i][2]);
          }
          var coords = atomInfoArray[i][3].split(/\s/);
          //console.log("coords -> %o", coords);
          x_map[i-1] = coords[0];
          y_map[i-1] = coords[2];
          z_map[i-1] = coords[4];
          //console.log("i(%i) => %s", i, atomInfoArray[i][2]);
        }
        //free up array for GC (reinit queues for GC faster than setting length to 0)
        atomInfoArray = [];
      }

      //handling local file input to upload box on change
      function handleFiles(e) {
        var files = e.files;
        var output = "";
        if (window.File && window.FileReader && window.FileList && window.Blob) {
          var reader = new FileReader();
          reader.onload = (function(file) {
              return function(e) {
                  var res = e.target.result;
                  res = res.split(/ATOM\s*\d+\s/);
                  res[0] = ""; //garbage index
                  //console.log(res[res.length-1]);
                  var index = res[res.length-1].search(/TER\s/);
                  res[res.length-1] = res[res.length-1].slice(0,index);
                  document.getElementById("spanBox").innerHTML = res[res.length-1];
                  parseHandler(res);
              };
          }) (files[0]);
          reader.onprogress = function(event) {
              if (event.lengthComputable) {
                  document.getElementById("spanBox").innerHTML = event.loaded + ", " + event.total;
              }
          };

          reader.readAsText(files[0]); //assumes UTF-8 encoding by default
        } else {
          alert('The File APIs are not fully supported by your browser.');
        }
      }

      //document.getElementById('pdb_input').addEventListener('change', handleFiles, false);

    </script>

  </body>
</html>
